<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="https://www.pngplay.com/wp-content/uploads/1/Letter-X-PNG-Stock-Photo.png">
<link rel="stylesheet" href="/style/style.css">
<title>Agent Dashboard</title>
</head>
<body>

<nav class="NavBar">
  <ul>
   <li><a href="/">Home</a></li>
          <li><a href="#OpenTickets" onclick="showSection('OpenTickets')">Open Tickets</a></li>
          <li><a href="#ResolvedTickets" onclick="showSection('ResolvedTickets')">Resolved Tickets</a></li>
  </ul>
</nav>

<div class="section" id="OpenTickets">
  <h2>Open Tickets</h2>
  <table id="ticketsTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Type</th>
        <th>Description</th>
        <th>User Email</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="openTicketsBody"></tbody>
  </table>
</div>


<div class="section" id="ResolvedTickets">
  <h2>Resolved Tickets</h2>
  <table id="ticketsTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Type</th>
        <th>Description</th>
        <th>User Email</th>
        <th>Status</th>
        <th>Messages</th>
      </tr>
    </thead>
    <tbody id="resolvedTicketsBody"></tbody>
  </table>
</div>

<script>
// Show only one section at a time
function showSection(sectionId) {
  const sections = ["OpenTickets", "ResolvedTickets"];
  sections.forEach(id => {
    document.getElementById(id).style.display = (id === sectionId) ? "block" : "none";
  });

  // Highlight active navbar link
  document.querySelectorAll(".NavBar a").forEach(a => {
    a.classList.toggle("active", a.getAttribute("href") === `#${sectionId}`);
  });
}

// Load tickets from backend
async function loadTickets() {
  try {
    const res = await fetch("/api/tickets");
    const tickets = await res.json();

    const openBody = document.getElementById("openTicketsBody");
    const resolvedBody = document.getElementById("resolvedTicketsBody");

    openBody.innerHTML = "";
    resolvedBody.innerHTML = "";

    tickets.forEach(ticket => {
      if(ticket.status === "Open") {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${ticket.id}</td>
          <td>${ticket.title}</td>
          <td>${ticket.type}</td>
          <td>${ticket.description}</td>
          <td>${ticket.userEmail}</td>
          <td>${ticket.status}</td>
          <td class = "check">
            <input type="text" placeholder="Add message" id="msg-${ticket.id}" />
            <button class="resolve-btn" title="Resolve" onclick="resolveTicket(${ticket.id})">Resolve
              <i class="fa fa-check"></i>
            </button>
            <button class="delete-btn" title="Delete" onclick="deleteTicket(${ticket.id})">Delete
              <i class="fa fa-trash"></i>
            </button>
          </td>
        `;
        openBody.appendChild(tr);
      } else if(ticket.status === "Resolved") {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${ticket.id}</td>
          <td>${ticket.title}</td>
          <td>${ticket.type}</td>
          <td>${ticket.description}</td>
          <td>${ticket.userEmail}</td>
          <td>${ticket.status}</td>
          <td>
            ${ticket.messages.map(msg => `
              <strong>${msg.agent}:</strong> ${msg.message} 
              <em>(${new Date(msg.timestamp).toLocaleString()})</em>
            `).join("<br>")}
          </td>
        `;
        resolvedBody.appendChild(tr);
      }
    });

  } catch(err) {
    console.error("Error loading tickets:", err);
    alert("Failed to load tickets");
  }
}

// Delete ticket
async function deleteTicket(id) {
  if (!confirm("Are you sure you want to delete this ticket?")) return;

  try {
    const res = await fetch(`/api/tickets/${id}`, { method: "DELETE" });
    const result = await res.json();
    if(result.success) {
      loadTickets();
    } else alert("Failed to delete ticket");
  } catch(err) {
    console.error(err);
    alert("Error deleting ticket");
  }
}

// Resolve ticket
async function resolveTicket(id) {
  const msgInput = document.getElementById(`msg-${id}`);
  const message = msgInput.value.trim();
  if(!message) return alert("Please enter a message before resolving.");

  try {
    // Add agent message
    await fetch(`/api/tickets/${id}/messages`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message, agent: "Agent" }) // replace with real agent name
    });

    // Update ticket status to Resolved
    const tickets = await fetch("/api/tickets").then(r => r.json());
    const ticket = tickets.find(t => t.id === id);
    ticket.status = "Resolved";

    await fetch(`/api/tickets/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(ticket)
    });

    loadTickets();
  } catch(err) {
    console.error(err);
    alert("Error resolving ticket");
  }
}

// Initial load
window.addEventListener("DOMContentLoaded", () => {
  showSection("OpenTickets");
  loadTickets();
});
</script>

</body>
</html>
